:_content-type: REFERENCE
:description: jq expressions in data filtering
:keywords: kogito, workflow, serverless, jq, expression, data, filtering
:navtitle: Example of jq expressions in data filtering
// :page-aliases:

[id="ref-example-jq-expression-data-filtering"]

= Example of jq expressions in data filtering

The Serverless Workflow specification defines the following filtering mechanisms to select which information must be part of the workflow data model:

* link:{spec_doc_url}#action-data-filters[Action data filters]: Select the part of the action result that is merged into the data model, which overrides the properties that share the name with the selected action result.
* link:{spec_doc_url}#event-data-filters[Event data filters]: Similar to the action data filters, but apply to the events instead of actions.
* link:{spec_doc_url}#state-data-filters[State data filters]: Define the workflow model to the JSON object, which is returned by the expression and discards an existing property.

State and Action data filter example::
+
--
You can see link:{kogito_sw_examples_url}/serverless-workflow-expression-quarkus[`serverless-workflow-expression-quarkus`] example application, in which actions and state data filters are used.

image::core/expression_diagram.png[]

Following is an expression function in `serverless-workflow-expression-quarkus` example application:

.Example expression function in `serverless-workflow-expression-quarkus`
[source,json]
----
"functions": [
    {
      "name": "max",
      "type": "expression",
      "operation": "{max: .numbers | max_by(.x), min: .numbers | min_by(.y)}"
    }
]
----

In the previous example, an array of complex numbers (`x` is real coordinate and `y` is imaginary coordinate) is accepted and an expression function is defined to calculate the maximum value of `x` and minimum value of `y` for the `numbers` array.

Also, the `serverless-workflow-expression-quarkus` example application contains an action data filter defined inside `squareState` action and a state data filter defined inside `finish` state. The action data filter selects the maximum value of `x` to be merged to the workflow model, and the state data filter defines the maximum value as the entire workflow model that is returned as the workflow response.

The previous example expression also contains a `max` function of type expression and an `operation` property containing a string of jq expression. This jq expression returns a JSON object, in which the `max` property is the maximum value of the `x` coordinate and the `min` property is the minimum value of the `y` coordinate.

Following is an action data filter in `serverless-workflow-expression-quarkus` example application:

.Example action data filter in `serverless-workflow-expression-quarkus`
[source,json]
----
"actions": [
        {
          "name": "maxAction",
          "functionRef": {
            "refName": "max"
          },
          "actionDataFilter": {
             "results" : ".max.x",
             "toStateData" : ".number"
          }
        }
 ]
----

In case the previous example of action data filter is not added in the `serverless-workflow-expression-quarkus`, then the entire JSON object returned by the function is merged into the workflow model. The previous action data filter contains the following properties:

* `results`, selecting the attribute from the data returned by the action.
* `toStateData`, indicating the name of the target property inside the workflow model. If the target property does not exist, then a target property is added.

Therefore, after executing the action, the workflow model consists of a `number` property, containing the maximum value of `x` and the original `numbers` array. After that, the workflow transitions to the `finish` state.

.Example state data filter in `serverless-workflow-expression-quarkus`
[source,json]
----
"name": "finish",
"type": "operation",
"stateDataFilter": {
   "input": "{result: .number}"
}
----

The original `numbers` array should not be returned as a result of the workflow execution, therefore the final stage consists of a state data filter defining the content of the output model. The output model should contain a `result` property and the value of `result` property should be the maximum number that is stored by the previous state in the `number` property.

In the previous example, the workflow model is changed by the `input` property of the filter, which means that the output model is updated before the state is executed. As a final result, the output model consists of a `result` property, containing the maximum value of `x`.
--

Event data filter example::
+
--

You can find an example of event data filtering in the link:{kogito_sw_examples_url}/serverless-workflow-callback-quarkus[`serverless-workflow-callback-quarkus`] example application.

.Example event filter
[source,json]
----
  "eventRef": "waitEvent",
  "eventDataFilter": {
     "data": ".result",
     "toStateData": ".move"
   }
----

The previous example of the event filter copies the content of CloudEvent data `result` field into the workflow model `move` field.
--
